<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CurveLab — Gráfico</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%230f172a'/%3E%3Cpath d='M12 48 C16 44, 22 20, 32 18 S48 30, 52 14' stroke='%2338bdf8' stroke-width='3.5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='16' cy='42' r='3' fill='%23f472b6'/%3E%3Ccircle cx='28' cy='22' r='3' fill='%23f472b6'/%3E%3Ccircle cx='40' cy='26' r='3' fill='%23f472b6'/%3E%3Ccircle cx='50' cy='16' r='3' fill='%23f472b6'/%3E%3Cline x1='12' y1='52' x2='54' y2='52' stroke='%2364748b' stroke-width='1.5'/%3E%3Cline x1='10' y1='10' x2='10' y2='52' stroke='%2364748b' stroke-width='1.5'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-deep:     #0b1120;
      --bg-card:     #1e293b;
      --accent:      #38bdf8;
      --accent-glow: rgba(56,189,248,0.25);
      --text:        #e2e8f0;
      --text-muted:  #94a3b8;
      --text-dim:    #64748b;
      --border:      rgba(148,163,184,0.12);
      --radius-sm: 8px;
      --radius-lg: 16px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      -webkit-font-smoothing: antialiased;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle, rgba(56,189,248,0.04) 1px, transparent 1px);
      background-size: 32px 32px;
      pointer-events: none;
      z-index: 0;
    }

    .chart-wrapper {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 1100px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: 0 1px 3px rgba(0,0,0,.3), 0 4px 24px rgba(0,0,0,.25);
      overflow: hidden;
    }

    .chart-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 20px;
      background: rgba(56,189,248,0.04);
      border-bottom: 1px solid var(--border);
    }

    .chart-header svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .chart-header h1 {
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin: 0;
    }

    .chart-body {
      position: relative;
      background: #0f172a;
      padding: clamp(16px, 3vw, 32px);
      aspect-ratio: 16 / 9;
    }

    .chart-body canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      gap: 10px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-msg {
      position: relative;
      z-index: 1;
      text-align: center;
      color: #fb7185;
      font-size: 0.9rem;
      padding: 40px 20px;
    }

    @media (min-width: 768px) {
      .chart-body {
        aspect-ratio: 2 / 1;
      }
    }
  </style>
</head>
<body>
  <div class="chart-wrapper">
    <div class="chart-header">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <h1>Visualização Gráfica</h1>
    </div>
    <div class="chart-body">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        Gerando gráfico...
      </div>
      <canvas id="graficoAjuste" style="display:none"></canvas>
    </div>
  </div>

  <script>
    const CORES_AJUSTE = {
      linear: '#f472b6',
      parabolico: '#38bdf8',
      exponencial: '#fbbf24',
      hiperbolico: '#34d399',
      logaritmico: '#a78bfa',
      potencial: '#fb923c'
    };

    const NOMES_AJUSTE = {
      linear: 'Linear',
      parabolico: 'Parabólico',
      exponencial: 'Exponencial',
      hiperbolico: 'Hiperbólico',
      logaritmico: 'Logarítmico',
      potencial: 'Potencial'
    };

    async function inicializar() {
      const params = new URLSearchParams(window.location.search);
      const xStr = params.get('x');
      const yStr = params.get('y');
      const tipo = params.get('tipo');

      if (!xStr || !yStr || !tipo) {
        mostrarErro('Parâmetros inválidos. Abra o gráfico pela página principal.');
        return;
      }

      const valoresX = xStr.split(',').map(Number);
      const valoresY = yStr.split(',').map(Number);

      if (valoresX.some(isNaN) || valoresY.some(isNaN)) {
        mostrarErro('Valores numéricos inválidos.');
        return;
      }

      try {
        const response = await fetch('/api/pontos-curva', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ valoresX, valoresY, tipo, numPontos: 100 })
        });

        const curvaData = await response.json();

        if (!curvaData.sucesso) {
          mostrarErro('Erro: ' + curvaData.erro);
          return;
        }

        renderizarGrafico(valoresX, valoresY, tipo, curvaData);
      } catch (error) {
        console.error('Erro:', error);
        mostrarErro('Erro ao conectar com o servidor.');
      }
    }

    function renderizarGrafico(valoresX, valoresY, tipo, curvaData) {
      document.getElementById('loading').style.display = 'none';
      const canvas = document.getElementById('graficoAjuste');
      canvas.style.display = 'block';

      const pontosOriginais = valoresX.map((x, i) => ({ x, y: valoresY[i] }));

      const datasets = [
        {
          label: 'Dados Experimentais',
          data: pontosOriginais,
          backgroundColor: '#f472b6',
          borderColor: '#f472b6',
          pointRadius: 6,
          pointHoverRadius: 9,
          pointStyle: 'circle',
          pointBorderWidth: 2,
          pointBorderColor: '#fff',
          showLine: false
        }
      ];

      if (tipo === 'todos') {
        curvaData.curvas.forEach(curva => {
          const pontosCurva = curva.x.map((x, i) => ({ x, y: curva.y[i] }));
          const nome = NOMES_AJUSTE[curva.tipo] || curva.tipo;
          datasets.push({
            type: 'line',
            label: `${nome} (R²=${curva.r2.toFixed(4)})`,
            data: pontosCurva,
            borderColor: CORES_AJUSTE[curva.tipo],
            backgroundColor: 'transparent',
            showLine: true,
            fill: false,
            pointRadius: 0,
            borderWidth: 2.5,
            tension: 0.4
          });
        });
      } else {
        const pontosCurva = curvaData.pontosCurva.x.map((x, i) => ({
          x,
          y: curvaData.pontosCurva.y[i]
        }));
        const nome = NOMES_AJUSTE[tipo] || tipo;
        datasets.push({
          type: 'line',
          label: `${nome} (R²=${curvaData.r2.toFixed(4)})`,
          data: pontosCurva,
          borderColor: CORES_AJUSTE[tipo],
          backgroundColor: 'transparent',
          showLine: true,
          fill: false,
          pointRadius: 0,
          borderWidth: 2.5,
          tension: 0.4
        });
      }

      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'scatter',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'nearest',
            intersect: false
          },
          plugins: {
            title: {
              display: true,
              text: 'Análise de Regressão',
              font: { size: 16, weight: '600', family: 'Inter' },
              color: '#e2e8f0',
              padding: { bottom: 16 }
            },
            legend: {
              position: 'bottom',
              labels: {
                color: '#94a3b8',
                font: { size: 12, family: 'Inter' },
                padding: 16,
                usePointStyle: true,
                pointStyleWidth: 12
              }
            },
            tooltip: {
              backgroundColor: 'rgba(15,23,42,0.95)',
              titleColor: '#38bdf8',
              bodyColor: '#e2e8f0',
              borderColor: 'rgba(56,189,248,0.3)',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              callbacks: {
                label: function(context) {
                  return `  (${context.parsed.x.toFixed(4)}, ${context.parsed.y.toFixed(4)})`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: {
                display: true,
                text: 'X',
                font: { size: 13, weight: '600', family: 'Inter' },
                color: '#94a3b8'
              },
              grid: {
                color: 'rgba(148,163,184,0.08)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: { size: 11, family: 'JetBrains Mono' }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Y',
                font: { size: 13, weight: '600', family: 'Inter' },
                color: '#94a3b8'
              },
              grid: {
                color: 'rgba(148,163,184,0.08)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: { size: 11, family: 'JetBrains Mono' }
              }
            }
          }
        }
      });
    }

    function mostrarErro(msg) {
      document.getElementById('loading').style.display = 'none';
      const wrapper = document.querySelector('.chart-body');
      wrapper.innerHTML = `<div class="error-msg">${msg}</div>`;
    }

    // Inicializa ao carregar a página
    inicializar();
  </script>
</body>
</html>
